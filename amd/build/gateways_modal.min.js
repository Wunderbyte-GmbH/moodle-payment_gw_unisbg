define(['exports', 'core/ajax', 'core/templates', 'core/modal_factory'], (function (exports, Ajax, Templates, ModalFactory) { 'use strict';

    function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

    var Ajax__default = /*#__PURE__*/_interopDefaultLegacy(Ajax);
    var Templates__default = /*#__PURE__*/_interopDefaultLegacy(Templates);
    var ModalFactory__default = /*#__PURE__*/_interopDefaultLegacy(ModalFactory);

    // This file is part of Moodle - http://moodle.org/

    /**
     * Inits and returns the config for payment process with unisbg
     *
     * @param {string} component Name of the component that the itemId belongs to
     * @param {string} paymentArea The area of the component that the itemId belongs to
     * @param {number} itemId An internal identifier that is used by the component
     * @returns {Promise<{clientid: string, brandname: string, cost: number, currency: string,
     * purchaseid: string, rooturl: string, environment: string, language: string, provider: any}>}
     */
    const getConfigForJs = (component, paymentArea, itemId) => {
        const request = {
            methodname: 'paygw_unisbg_get_config_for_js',
            args: {
                component,
                paymentarea: paymentArea,
                itemid: itemId,
            },
        };

        return Ajax__default["default"].call([request])[0];
    };

    /* eslint-disable no-unused-vars */

    /**
     * Creates and shows a modal that contains a placeholder.
     *
     * @returns {Promise<Modal>}
     */
    const showModalWithPlaceholder = async() => {
        const modal = await ModalFactory__default["default"].create({
            body: await Templates__default["default"].render('paygw_unisbg/unisbg_button_placeholder', {})
        });
        modal.show();
        return modal;
    };


    /**
     * Process the payment.
     *
     * @param {string} component Name of the component that the itemId belongs to
     * @param {string} paymentArea The area of the component that the itemId belongs to
     * @param {number} itemId An internal identifier that is used by the component
     * @param {string} description Description of the payment
     * @returns {Promise<string>}
     */
    const process = (component, paymentArea, itemId, description) => {
        return Promise.all([
                showModalWithPlaceholder(),
                getConfigForJs(component, paymentArea, itemId),
            ])
            .then(([modal, unisbgConfig]) => {
                return Promise.all([
                    modal,
                    unisbgConfig,
                ]);
            })
            .then(([modal, unisbgConfig]) => {

                const providersjson = JSON.parse(unisbgConfig.providerobject);
                const optionsel = document.createElement('div');

                const context = {
                    listofproviders: providersjson.object,
                    cartid: unisbgConfig.cartid,
                    component,
                    paymentarea: paymentArea,
                    itemid: itemId,
                };

                Templates__default["default"].renderForPromise('paygw_unisbg/paymentoptions', context).then(({html, js}) => {

                        modal.setBody(optionsel);

                        // We need a minimal delay to make sure we run the js only after the modal has its body.
                        setTimeout(() => {
                            Templates__default["default"].appendNodeContents(optionsel, html, js);
                        }, 50);
                        return true;
                    }).catch();

                return '';

            }).then(x => {
                const promise = new Promise(resolve => {
                    window.addEventListener('onbeforeunload', (e) => {
                        promise.resolve();
                    });
                });
                return promise;
            });
    };

    exports.process = process;

    Object.defineProperty(exports, '__esModule', { value: true });

}));

//# sourceMappingURL=gateways_modal.min.js.map